<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagamento e Desbloqueio de PDFs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- libs necess√°rias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: 'Times New Roman', serif; background: #e0f7fa; margin:0; padding:0; color:#333; }
header { background-color: #007BFF; color:white; padding:20px; text-align:center; font-size:22px; font-weight:bold; box-shadow:0 3px 6px rgba(0,0,0,0.15);}
main { max-width:750px; margin:30px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 6px 15px rgba(0,0,0,0.1);}
h2 { text-align:center; margin-bottom:15px; color:#007BFF; }
.instrucoes-gerais { font-size:15px; margin-bottom:20px; text-align:center; line-height:1.5; }

/* Pacotes */
.pacotes-container { display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
.pacote { flex:1; min-width:150px; padding:15px; border-radius:12px; text-align:center; font-weight:bold; font-size:15px; color:white; cursor:default; transition:all 0.3s ease; box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.pacote:hover { transform:scale(1.08); box-shadow:0 8px 20px rgba(0,0,0,0.25); }
.pacote1 { background-color:#6c757d; }
.pacote5 { background-color:#007BFF; }
.pacote15 { background-color:#28a745; }
.pacote20 { background-color:#ffc107; color:#333; }

/* M√©todos */
.metodo-container { text-align:center; margin:25px 0 10px 0; }
.metodo-container p { font-weight:bold; font-size:16px; margin-bottom:10px; }
.metodo-selecao button { margin:10px; padding:18px 15px; font-size:16px; border-radius:12px; border:none; cursor:pointer; transition:0.3s; font-weight:bold; display:inline-flex; flex-direction:column; align-items:center; gap:8px; box-shadow:0 4px 10px rgba(0,0,0,0.15);}
button#btnEmola { background-color:#FFD700; color:#333; }
button#btnMpesa { background-color:#FF4500; color:white; }
button:hover { opacity:0.85; transform: translateY(-2px); }

/* Cart√µes de M√©todo */
.metodo-card { display:none; margin:15px auto; padding:18px; border-radius:12px; text-align:center; background:#f8f9fa; box-shadow:0 5px 12px rgba(0,0,0,0.15); transition:all 0.3s ease; }
.metodo-card:hover { transform:translateY(-3px); box-shadow:0 8px 20px rgba(0,0,0,0.2); }
.metodo-card i { font-size:54px; margin-bottom:10px; display:block; }
.metodo-card p { font-size:16px; margin:5px 0; font-weight:bold; }
.metodo-card button { margin:5px; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-size:14px; transition:0.3s; }
.metodo-card button:hover { opacity:0.9; transform: translateY(-2px); }

/* Campo de c√≥digo */
.input-container { display:none; justify-content:center; gap:8px; margin-top:15px; flex-direction:column; align-items:center; }
input[type="text"] { padding:12px; font-size:15px; border-radius:8px; border:1px solid #ccc; width:220px; text-align:center; text-transform:uppercase;}
button.confirmar-btn { padding:12px 16px; font-size:15px; border-radius:8px; border:none; background-color:#28a745; color:white; cursor:pointer; transition:0.3s; }
button.confirmar-btn:hover { background-color:#218838; transform: translateY(-2px); }
.mensagem { margin-top:18px; text-align:center; font-size:17px; font-weight:bold; }

/* Spinner */
.spinner { border:4px solid #f3f3f3; border-top:4px solid #007BFF; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; display:inline-block; margin-left:8px; vertical-align:middle; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<body>
<header>Pagamento e Desbloqueio de PDFs</header>

<main>
<h2>Como Funciona</h2>
<p class="instrucoes-gerais">
1Ô∏è‚É£ Veja os pacotes dispon√≠veis abaixo.<br>
2Ô∏è‚É£ Escolha Emola ou Mpesa para efetuar a transfer√™ncia.<br>
3Ô∏è‚É£ Receba seu c√≥digo secreto via SMS.<br>
4Ô∏è‚É£ Digite o c√≥digo para desbloquear seu pacote.
</p>

<div class="pacotes-container">
  <div class="pacote pacote1">1 PDF - 5 MT</div>
  <div class="pacote pacote5">5 PDFs - 25 MT</div>
  <div class="pacote pacote15">15 PDFs - 60 MT</div>
  <div class="pacote pacote20">20 PDFs - 80 MT</div>
</div>

<div class="metodo-container">
<p>Selecione o M√©todo de Pagamento:</p>
<div class="metodo-selecao">
<button id="btnEmola" onclick="selecionarMetodo('Emola')"><i class="fas fa-wallet"></i>Emola</button>
<button id="btnMpesa" onclick="selecionarMetodo('Mpesa')"><i class="fas fa-mobile-alt"></i>Mpesa</button>
</div>
</div>

<div id="metodo-Emola" class="metodo-card">
<i class="fas fa-wallet" style="color:#FFD700;"></i>
<p>Emola</p>
<p>N√∫mero: <strong>864920606</strong></p>
<button onclick="copiarNumero('864920606')">Copiar</button>
<button onclick="window.location.href='tel:*898%23'">Pagar Agora</button>
<p style="margin-top:8px; font-size:14px; font-weight:bold;">Confirma√ß√£o: Benjamim Janu√°rio Paulino</p>
</div>

<div id="metodo-Mpesa" class="metodo-card">
<i class="fas fa-mobile-alt" style="color:#FF4500;"></i>
<p>Mpesa</p>
<p>N√∫mero: <strong>848960732</strong></p>
<button onclick="copiarNumero('848960732')">Copiar</button>
<button onclick="window.location.href='tel:*150%23'">Pagar Agora</button>
<p style="margin-top:8px; font-size:14px; font-weight:bold;">Confirma√ß√£o: Benjamim Janu√°rio Paulino</p>
</div>

<div class="input-container" id="input-codigo">
  <input type="text" id="codigo-acesso" placeholder="Introduza o C√≥digo de Desbloqueio" maxlength="8">
  <span id="feedback-codigo" style="color:#dc3545; font-size:13px; display:block; text-align:center; margin-top:5px;"></span>
  <button class="confirmar-btn" onclick="validarCodigo()">Confirmar</button>
</div>

<div id="mensagem" class="mensagem"></div>

<script>
const URL_APP = "https://script.google.com/macros/s/AKfycby-l_VBnTuG98erRyPk0NA_QZvOJQnuix4P2zp2gnQCwvx5QFG9L9WgydoIHeMpofILnA/exec";

const inputCodigo = document.getElementById('codigo-acesso');
const feedback = document.getElementById('feedback-codigo');

inputCodigo.addEventListener('input', () => {
  let valor = inputCodigo.value.toUpperCase();
  const novoValor = valor.replace(/[^A-Z0-9]/g, '');
  if(valor !== novoValor){
    feedback.innerText = "‚ùå Apenas caracteres alfanum√©ricos s√£o permitidos!";
  } else {
    feedback.innerText = "";
  }
  inputCodigo.value = novoValor.slice(0, 8);
});

function selecionarMetodo(metodo){
  document.getElementById('metodo-Emola').style.display = metodo==='Emola'?'block':'none';
  document.getElementById('metodo-Mpesa').style.display = metodo==='Mpesa'?'block':'none';
  document.getElementById('input-codigo').style.display = 'flex';
}

function copiarNumero(numero){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(numero).then(()=> alert('N√∫mero copiado!')).catch(()=> fallbackCopy(numero));
  } else {
    fallbackCopy(numero);
  }
}
function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    alert('N√∫mero copiado!');
  } catch(e) {
    prompt('Copie manualmente este n√∫mero:', text);
  }
  ta.remove();
}

function validarCodigo(){
  const codigo = inputCodigo.value.trim().toUpperCase();
  const msg = document.getElementById('mensagem');

  if(codigo.length !== 8){
    msg.style.color = "#dc3545";
    msg.innerText = "‚ùå O c√≥digo deve ter 8 caracteres.";
    return;
  }

  msg.style.color = "#007BFF";
  msg.innerHTML = 'üîç Verificando o C√≥digo <span class="spinner"></span>';

  fetch(`${URL_APP}?codigo=${codigo}`, { method:'GET', mode:'cors' })
    .then(res => {
      if(!res.ok) throw new Error('Servi√ßo indispon√≠vel');
      return res.json();
    })
    .then(data => {
      if(data && data.valido){
        msg.style.color = "#28a745";
        msg.innerText = `üéâ C√≥digo v√°lido! PDFs restantes: ${data.restante}`;

        const planoDataJSON = sessionStorage.getItem("planoData");
        if(!planoDataJSON){
            alert("‚ùå Nenhum plano encontrado. Gere o plano antes de tentar desbloquear.");
            return;
        }

        const planoData = JSON.parse(planoDataJSON);

        // --- GERA O PDF COM AUTOTABLE ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });

        doc.setFont("times", "normal");
        doc.setFontSize(12);

        // --- P√ÅGINA 1: Preliminares (em duas colunas) + primeiras 2 linhas da tabela ---
        doc.text("PLANO DE AULA", 148, 10, { align: "center" });
        doc.setFontSize(10);

        // Extrai os dados do HTML salvo
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = planoData.html;

        // Dados da Esquerda
        let yLeft = 20;
        const addLineLeft = (label, value) => {
          if (value) {
            doc.text(`${label}:`, 10, yLeft);
            doc.text(value, 45, yLeft);
            yLeft += 5;
          }
        };

        const dadosEsquerda = tempDiv.querySelector('#dadosEsquerda');
        if (dadosEsquerda) {
          const esquerdaText = dadosEsquerda.innerText;
          const lines = esquerdaText.split('\n');
          lines.forEach(line => {
            if (line.includes(':')) {
              const [label, value] = line.split(':', 2);
              addLineLeft(label.trim(), value.trim());
            }
          });
        }

        // Dados da Direita
        let yRight = 20;
        const addLineRight = (label, value) => {
          if (value) {
            doc.text(`${label}:`, 160, yRight);
            doc.text(value, 200, yRight);
            yRight += 5;
          }
        };

        const dadosDireita = tempDiv.querySelector('#dadosDireita');
        if (dadosDireita) {
          const direitaText = dadosDireita.innerText;
          const lines = direitaText.split('\n');
          lines.forEach(line => {
            if (line.includes(':')) {
              const [label, value] = line.split(':', 2);
              addLineRight(label.trim(), value.trim());
            }
          });
        }

        // Objetivos
        const listaObjetivos = tempDiv.querySelector('#listaObjetivos');
        if (listaObjetivos) {
          doc.text("Objetivos Espec√≠ficos:", 10, yLeft);
          yLeft += 5;
          const objetivos = listaObjetivos.querySelectorAll('li');
          objetivos.forEach(obj => {
            doc.text(`‚Ä¢ ${obj.innerText.trim()}`, 15, yLeft);
            yLeft += 5;
          });
        }

        // Tabela - apenas as 2 primeiras linhas
        const tabela = tempDiv.querySelector('#tabelaPlano');
        if (tabela) {
          const rows = tabela.querySelectorAll('tbody tr');
          const firstTwoRows = Array.from(rows).slice(0, 2);
          const tableDataPage1 = firstTwoRows.map(row => {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).map(cell => {
              // Remove tags HTML, mant√©m quebras de linha
              let text = cell.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
              // Garante que cada linha comece com ‚Ä¢ se for conte√∫do, prof ou aluno
              if (cell.cellIndex >= 2 && cell.cellIndex <= 4) {
                text = text.split('\n').map(line => line.trim() ? `‚Ä¢ ${line.trim()}` : '').filter(l => l).join('\n');
              }
              return text;
            });
          });

          doc.autoTable({
            startY: yLeft + 5,
            head: [['TEMPO', 'FUN√á√ïES DID√ÅCTICAS', 'CONTE√öDOS', 'ACTIVIDADES DO PROFESSOR', 'ACTIVIDADES DOS ALUNOS', 'M√âTODOS DE ENSINO', 'MEIOS DE ENSINO']],
            body: tableDataPage1,
            theme: 'grid',
            styles: {
              fontSize: 8,
              font: 'times',
              fontStyle: 'normal',
              cellPadding: 2,
              valign: 'top',
              overflow: 'linebreak'
            },
            headStyles: {
              fillColor: [0, 105, 217],
              fontSize: 8,
              font: 'times',
              fontStyle: 'bold'
            },
            columnStyles: {
              0: { cellWidth: 18 },
              1: { cellWidth: 35 },
              2: { cellWidth: 40 },
              3: { cellWidth: 40 },
              4: { cellWidth: 40 },
              5: { cellWidth: 30 },
              6: { cellWidth: 30 }
            }
          });
        }

        // --- P√ÅGINA 2: √öltimas 2 linhas da tabela + Anexo ---
        doc.addPage();

        if (tabela) {
          const rows = tabela.querySelectorAll('tbody tr');
          const lastTwoRows = Array.from(rows).slice(2, 4);
          const tableDataPage2 = lastTwoRows.map(row => {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).map(cell => {
              let text = cell.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
              if (cell.cellIndex >= 2 && cell.cellIndex <= 4) {
                text = text.split('\n').map(line => line.trim() ? `‚Ä¢ ${line.trim()}` : '').filter(l => l).join('\n');
              }
              return text;
            });
          });

          doc.autoTable({
            startY: 20,
            head: [['TEMPO', 'FUN√á√ïES DID√ÅCTICAS', 'CONTE√öDOS', 'ACTIVIDADES DO PROFESSOR', 'ACTIVIDADES DOS ALUNOS', 'M√âTODOS DE ENSINO', 'MEIOS DE ENSINO']],
            body: tableDataPage2,
            theme: 'grid',
            styles: {
              fontSize: 8,
              font: 'times',
              fontStyle: 'normal',
              cellPadding: 2,
              valign: 'top',
              overflow: 'linebreak'
            },
            headStyles: {
              fillColor: [0, 105, 217],
              fontSize: 8,
              font: 'times',
              fontStyle: 'bold'
            },
            columnStyles: {
              0: { cellWidth: 18 },
              1: { cellWidth: 35 },
              2: { cellWidth: 40 },
              3: { cellWidth: 40 },
              4: { cellWidth: 40 },
              5: { cellWidth: 30 },
              6: { cellWidth: 30 }
            }
          });
        }

        // --- ANEXO ---
        let anexoY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 30;

        if (planoData.anexoSalvo) {
          if (planoData.anexoSalvo.tipo === 'imagem' && planoData.anexoSalvo.data) {
            doc.text("Anexo - Imagem:", 10, anexoY);
            anexoY += 10;
            const imgProps = doc.getImageProperties(planoData.anexoSalvo.data);
            const pageWidth = doc.internal.pageSize.getWidth() - 20;
            const imgHeight = (imgProps.height * pageWidth) / imgProps.width;

            if (anexoY + imgHeight > doc.internal.pageSize.getHeight() - 10) {
              doc.addPage();
              anexoY = 20;
            }

            doc.addImage(planoData.anexoSalvo.data, 'JPEG', 10, anexoY, pageWidth, imgHeight);
          } else if (planoData.anexoSalvo.tipo === 'texto' && planoData.anexoSalvo.data) {
            doc.text("Anexo - Texto Adicional:", 10, anexoY);
            anexoY += 10;
            const lines = doc.splitTextToSize(planoData.anexoSalvo.data, doc.internal.pageSize.getWidth() - 20);
            doc.text(lines, 10, anexoY);
          }
        }

        // Salvar PDF
        doc.save("plano_de_aula.pdf");

        // Salvar no hist√≥rico (opcional, se quiser implementar)
        // salvarNoHistorico(planoData);

        alert("‚úÖ PDF desbloqueado e baixado com sucesso!");
      } else {
        msg.style.color = "#dc3545";
        msg.innerText = `‚ùå ${data && data.msg ? data.msg : 'C√≥digo inv√°lido'}`;
      }
    })
    .catch(err => {
      msg.style.color = "#dc3545";
      msg.innerText = "‚ùå Erro ao validar c√≥digo. Tente novamente.";
      console.error(err);
    });
}

// Fun√ß√£o opcional para salvar no hist√≥rico
function salvarNoHistorico(planoData) {
  // Implemente conforme sua l√≥gica
}
</script>
</main>
</body>
</html>
